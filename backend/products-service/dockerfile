# ---- Etapa 1: Build y Test ----
FROM node:20-alpine AS builder

WORKDIR /app

# Copiar archivos de dependencias
COPY package*.json ./

# Instalar todas las dependencias (incluidas devDependencies para pruebas)
RUN npm install

# Copiar el resto del código fuente
COPY . .

# Ejecutar pruebas (si las pruebas fallan, la compilación se detiene aquí)
# Ejecutamos SOLO las pruebas unitarias, que no dependen de la BD.
RUN npm run test:unit

# ---- Etapa 2: Producción ----
FROM node:20-alpine AS production

WORKDIR /app

# Establecer el entorno a producción
ENV NODE_ENV=production

# Copiar archivos de dependencias
COPY package*.json ./

# Instalar solo las dependencias de producción de forma limpia
RUN npm ci --omit=dev

# Copiar el código de la aplicación desde la etapa de build
# Esto asegura que estamos usando el código que ya fue probado
COPY --from=builder /app .

# Exponer el puerto que la aplicación usará dentro del contenedor
# El docker-compose mapea el puerto 8001 del host a este puerto
EXPOSE 8001

# Comando para iniciar la aplicación
CMD ["node", "server.js"]
